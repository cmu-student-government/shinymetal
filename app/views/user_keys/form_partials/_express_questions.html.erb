<%= f.fields_for :express_app do |express_app| %>
  <fieldset id="express-app-fields">
    <legend>Application</legend>
    <ol>
      <li>
        This application is being submitted on behalf of a
        <%= express_app.select(:requester_type,
              ExpressApp.requester_types.keys.map { |k| [t("requester_types.#{k}.title"), k] },
              include_blank: true)
        %>
        <div id="requester-type-additional" class="hide">
          &nbsp;<span></span>:&nbsp;
          <%= express_app.text_field(:requester_additional_info) %>
        </div>
      </li>
      <li>
        In a sentence or two, describe the goal of your project and how the data you are requesting will be used.
        <%= express_app.text_area :reasoning, rows: 5, placeholder: "e.g. We are looking to create a mobile app that showcases events happening on campus based on the user's current location. We'd like to use the Bridge API to collect the most up-to-date information on organization's events on campus. The project is for our course XX-XXX and will culminate with a final presentation at the end of this semester." %>
      </li>
      <li>
        Access to student data can only be provisioned for short periods of time. Select your target end date for this project here, up to 5 months from now.
        <br>
        <em>*If longer term access is needed at the end of this period, a regular API application can be submitted when necessary.</em>
        <br>
        <%= f.date_field :time_expired, order: [:month, :day, :year], min_date: Date.today, max_date: Date.today + 5.months %>
      </li>
      <li>
        Please select all Endpoints and columns that you will need access to:
        <br>
        <% ExpressApp::WHITELIST_COLUMNS.keys.map(&:to_s).each do |endpoint| %>
          <span class="button secondary" data-endpoint="<%= endpoint %>" data-reveal-id="whitelist-picker"><%= endpoint.humanize %></span>
        <% end %>
      </li>
      <li>
        Check below to certify that you agree to the following:
        <ul>
          <li>I've read and agree to abide by the <a href="#">Terms of Service</a>.</li>
          <li>I pledge to keep the data accessed via The Bridge API secure and to myself.</li>
          <li>I understand that any acts in violation of this agreement will be reported as a <a href="http://www.cmu.edu/student-affairs/theword/comm_standards/standards.html">Community Standards</a> violation.</li>
        </ul>
        <br>
        <%= express_app.check_box :tos_agree %> Check here to certify that you've read the Terms of Service and pledge to keep the data accessed via The Bridge API secure and to yourself.
      </li>
    </ol>
  </fieldset>
<% end %>

<div id="whitelist-picker" class="reveal-modal" data-reveal aria-labelled-by="whitelist-picker-title" aria-hidden="true" role="dialog">
  <h3 class="header"><span></span> Columns:</h3>
  <% ExpressApp::WHITELIST_COLUMNS.keys.map(&:to_s).each do |endpoint| %>
    <table id="<%= endpoint %>-columns-table" class="hide columns-table">
      <tr>
        <th colspan="1"></th>
        <th>Column</th>
        <th>Description</th>
        <th>Example</th>
      </tr>
      <% ExpressApp::WHITELIST_COLUMNS[endpoint.to_sym].each do |col_name| %>
        <% column = Column.restrict_to(endpoint).find_by_column_name(col_name) %>
        <tr data-checkbox-id="user_keys_column_ids_<%= column.id %>">
          <td>
            <%= hidden_field_tag "user_key[column_ids][]" %>
            <%= check_box_tag "user_key[column_ids][]", column.id, @user_key.columns.include?(column), id: "user_keys_column_ids_#{column.id}" %>
          </td>
          <td><%= col_name.underscore.humanize.titleize %></td>
          <td><%= t("columns.#{endpoint}.#{col_name}.description") %></td>
          <td><%= t("columns.#{endpoint}.#{col_name}.example") %></td>
        </tr>
      <% end %>
    </table>
  <% end %>
</div>

<% content_for :js do %>
  <script type="text/javascript">
    $(function () {

      var req_types = <%= t("requester_types").to_json.html_safe %>;
      var additional_q_div = $("#requester-type-additional");

      $("#user_key_express_app_attributes_requester_type").change(function() {
        var val = $(this).val();
        if (val === "") {
          additional_q_div.addClass("hide");
          return;
        }

        additional_q_div.removeClass("hide");
        additional_q_div.find("span").text(req_types[val]['additional_q']);
        additional_q_div.find("input").attr("placeholder", "e.g. " + req_types[val]['example']);
      });

      $("[data-reveal-id='whitelist-picker']").click(function() {
        var endpoint = $(this).data("endpoint");
        $(".columns-table").addClass("hide");
        $("#" + endpoint + "-columns-table").removeClass("hide");
        $("#whitelist-picker .header span").text(endpoint.charAt(0).toUpperCase() + endpoint.slice(1));
      });

      $(".columns-table tr").click(function (e) {
        if (e.target.tagName.toLowerCase() === "input") return;
        var checkbox = $("#" + $(this).data("checkbox-id"));
        checkbox.prop("checked", !checkbox.prop("checked"));
      });

    });
  </script>
<% end %>
